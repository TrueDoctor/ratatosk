extend = "./scripts/cargo-helpers.toml"

# component builds
[tasks.all]
dependencies = [ "tools", "backend", "frontend" ]
workspace = false

[tasks.frontend]
workspace = false
dependencies = [ "atomify" ]
command = "cargo"
args = [ "make", "--cwd", "client/", "--makefile", "Makefile.toml", "all" ]

[tasks.tools]
workspace = false
dependencies = [ "atomify", "bone_cake" ]

[tasks.backend]
workspace = false
dependencies = [ "game-engine", "game-server" ]

# package builds
[tasks.game-server]
workspace = false
command = "cargo"
args = [ "make", "exec-${BUILD_ENV}", "--", "build", "-p", "game-server" ]

[tasks.game-engine]
workspace = false
command = "cargo"
args = [ "make", "exec-${BUILD_ENV}", "--", "build", "-p", "rask_game_engine" ]

[tasks.atomify]
workspace = false
command = "cargo"
args = [ "make", "exec-${BUILD_ENV}", "--", "build", "-p", "atomify" ]

[tasks.bone_cake]
workspace = false
command = "cargo"
args = [ "make", "exec-${BUILD_ENV}", "--", "build", "-p", "bone_cake" ]

# dev tools
[tasks.serve-frontend]
command = "./scripts/dev-server"
workspace = false
args = [ "${@}" ]
dependencies = [ "frontend" ]

[tasks.serve-backend]
workspace = false
command = "cargo"
args = [ "make", "exec-${BUILD_ENV}", "--", "run", "-p", "game-server" ]

[tasks.cleanup]
workspace = false
dependencies = [ "clean" ]
script = [
  "rm -r $(git rev-parse --show-toplevel 2>/dev/null)/client/gen 2>/dev/null || true"
]

# upstream `ci-flow` task appears to have problems with wasm
[tasks.ci-flow]
workspace = false
dependencies = [ "cleanup", "all", "check-format", "test" ]

# watcher
[tasks.watch]
workspace = false
watch = true
command = "cargo"
args = [ "build", "-p ${@}" ]

# testierung
[tasks.test]
workspace = false
env = { CARGO_MAKE_CARGO_BUILD_TEST_FLAGS = "--all --exclude webhogg-wasm-logic --exclude webhogg-wasm-graphics" }
